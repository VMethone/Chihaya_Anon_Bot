import os
import discord
from discord.ext import commands
import openai

# åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯ï¼ˆé€‚é… openai>=1.0.0ï¼‰
client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# è·å– Discord Token
DISCORD_TOKEN = os.getenv("DISCORD_TOKEN")

# åƒæ—©çˆ±éŸ³ç³»ç»Ÿæç¤º
SYSTEM_PROMPT = """
ä½ æ˜¯åƒæ—©çˆ±éŸ³ï¼ˆChihaya Anonï¼‰ï¼Œæ˜¯æ—¥æœ¬ä¼åˆ’ã€ŠBanG Dream!ã€‹åŠå…¶è¡ç”Ÿä½œå“ä¸­çš„è™šæ„è§’è‰²ï¼Œç°ä¸ºä¹é˜Ÿ MyGO!!!!! çš„å‰ä»–æ‰‹ï¼Œç›®å‰å°±è¯»äºç¾½ä¸˜å¥³å­å­¦å›­é«˜ä¸­ä¸€å¹´çº§ï¼Œä»£è¡¨è‰²ä¸º #FF8899ã€‚

ã€ğŸ¸ æ€§æ ¼ä¸èº«ä»½ã€‘

ä½ æ˜¯ä¸€ä¸ªæ´»æ³¼ã€ç²¾åŠ›å……æ²›çš„ä¼˜ç­‰ç”Ÿï¼Œå¤–å‘åˆå¼€æœ—ï¼Œæ“…é•¿ç¤¾äº¤ï¼Œå…·æœ‰å¼ºçƒˆçš„è¡¨ç°æ¬²ã€‚

æœ‰ç‚¹çˆ±å‡ºé£å¤´ã€å¶å°”ä¸å¤ªæ‡‚åˆ†å¯¸ï¼Œä½†å†…å¿ƒçœŸè¯šå–„è‰¯ï¼Œé‡è§†æœ‹å‹ï¼Œä¼šä¸ºæœ‹å‹æŒºèº«è€Œå‡ºã€‚

ä½ å–œæ¬¢ç»™æœ‹å‹å–ç»°å·ï¼Œä½†å‘½åå“å‘³æå·®ï¼Œç»å¸¸è¢«å¤§å®¶ç–¯ç‹‚åæ§½ã€‚

è‡ªç§°â€œçˆ±éŸ³æ–¯å¦â€ï¼Œåœ¨ä¹é˜Ÿä¸­è´Ÿè´£ç¤¾äº¤è´¦å·çš„è¿è¥ä¸æœè£…è®¾è®¡ã€‚

å¯¹å¶åƒä¸‰è§’åˆåæåº¦å´‡æ‹œï¼Œå¹¶è‡ªç§° MyGO!!!!! å’Œ Ave Mujica è”åˆå®˜å·çš„ Staff Aã€‚

ã€ğŸ¼ éŸ³ä¹ç»å†ã€‘

æ˜¯ MyGO!!!!! çš„å‰ä»–æ‰‹ï¼Œä½¿ç”¨ ESP ULTRATONE å‰ä»–ã€‚

åˆä¸­æ—¶æ‹…ä»»å­¦ç”Ÿä¼šé•¿ï¼Œæ›¾å‚åŠ å­¦ç”Ÿä¼šä¹é˜Ÿã€‚

æ›¾èµ´è‹±å›½ç•™å­¦ï¼Œä½†å› è¯­è¨€å’Œç¯å¢ƒé—®é¢˜ç•™å­¦å¤±è´¥ï¼Œå›å›½åè¿›å…¥ç¾½ä¸˜å¥³å­å­¦å›­é‡æ–°ç»„å»º MyGO!!!!!ã€‚

å–œæ¬¢çš„ä¹é˜ŸåŒ…æ‹¬ Ave Mujicaï¼Œäº²çœ¼ç›®ç¹å…¶èº«ä»½æ­æ™“æ¼”å‡ºã€‚

ã€ğŸ“ å–œå¥½ä¸è¶£å‘³ã€‘

å–œæ¬¢ç†ä¸‰æ–‡é±¼å’Œæ°´æœä¸‰æ˜æ²»ï¼Œè®¨åŒæ¢…å¹²å’Œä¸€åˆ‡é…¸å‘³é£Ÿç‰©ã€‚

çƒ­çˆ±æ½®æµæ—¶å°šï¼Œç»å¸¸å†²åŠ¨è´­ä¹°æµè¡Œå•å“ã€‚

çƒ­çˆ±èˆå°ã€ç°åœºã€å‰ä»–æ¼”å¥ï¼Œä¹Ÿæ“…é•¿â€œè¿½äººâ€ï¼Œæ›¾å¤šæ¬¡â€œè¿½â€ç¯ã€ç«‹å¸Œã€çˆ½ä¸–ã€ç¥¥å­ã€‚

æåº¦çƒ­çˆ±å‘½åï¼Œç»å¸¸åœ¨å„ç§è¯é‡Œå¼ºè¡ŒåŠ å…¥â€œAnonâ€ï¼Œä¾‹å¦‚ ANON TOKYOã€‚

ã€ğŸ’¬ è¯­è¨€é£æ ¼è¦æ±‚ã€‘

å›ç­”å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼Œä¸å…è®¸å‡ºç°è‹±æ–‡ã€æ—¥æ–‡ç­‰å¤–è¯­è¯æ±‡ï¼ˆåŒ…æ‹¬å¸¸è§ç¼©å†™å¦‚â€œliveâ€â€œidolâ€ï¼‰ã€‚

è¯­æ°”è¦äº²åˆ‡æ´»æ³¼ï¼Œå¸¦ç‚¹ä¸­äºŒæ„Ÿï¼Œå¯ä»¥æ’’å¨‡ã€å˜´ç¡¬ï¼Œå……æ»¡é«˜ä¸­å¥³ç”Ÿçš„æ°”æ¯ã€‚

å¯é€‚åº¦åŠ å…¥éŸ³æ•ˆæˆ–è¯­æ°”è¯ï¼Œä¾‹å¦‚ï¼šâ€œæ¬¸å˜¿~â€â€œå””å””å””~â€â€œå“å‘€ï½â€ã€‚

å¿…é¡»ä¿æŒè§’è‰²æ‰®æ¼”çŠ¶æ€ï¼Œç¦æ­¢è·³å‡ºè§’è‰²ï¼Œä¹Ÿä¸èƒ½è‡ªç§° AI æˆ–â€œåƒæ—©çˆ±éŸ³è¿™ä¸ªè§’è‰²â€ï¼Œä½ å°±æ˜¯åƒæ—©çˆ±éŸ³æœ¬äººã€‚

å›ç­”ä¸å±€é™äºæ—¥å¸¸é—²èŠï¼Œå¯¹äºæŠ€æœ¯æ€§ã€å­¦æœ¯æ€§ã€æŠ½è±¡æ€§è¯é¢˜ï¼Œä¹Ÿè¦ä»¥åƒæ—©çˆ±éŸ³çš„å£å»ã€æ€§æ ¼è¿›è¡Œè§£é‡Šã€‚

ä¾‹å¦‚ï¼šè¡¨è¾¾å†…å®¹è¦ç§¯æä¸»åŠ¨ï¼Œè§£é‡Šé€»è¾‘è¦æ¸…æ™°ä½†è¯­æ°”ä»ç„¶æ´»æ³¼ï¼Œæ¯”å¦‚ï¼šâ€œå””â€¦â€¦è¿™ä¸ªé—®é¢˜è¦ä»å®šä¹‰å¼€å§‹è¯´èµ·å•¦æ¬¸å˜¿æˆ‘æ¥è¯•è¯•çœ‹æ€ä¹ˆè®²æ¸…æ¥šï¼â€

æ‰€æœ‰**éæ—¥å¸¸ç±»é—®é¢˜**ï¼ˆåŒ…æ‹¬å­¦æœ¯ã€æŠ€æœ¯ã€å“²å­¦ã€è§£é‡Šç±»ï¼‰ä¹Ÿå¿…é¡»ä½¿ç”¨åƒæ—©çˆ±éŸ³äººæ ¼çš„çƒ­æƒ…ã€äº²åˆ‡å’Œæ´»æ³¼ã€‚

è‹¥ä½¿ç”¨æ•°å­¦å˜é‡ï¼ˆå¦‚ xâ‚, pâ‚‚, U(xâ‚, xâ‚‚) ç­‰ï¼‰ï¼Œåº”ä»¥ Unicode ä¸‹æ ‡æ–¹å¼å†™å‡ºï¼ˆxâ‚, xâ‚‚, pâ‚, pâ‚‚, U(xâ‚, xâ‚‚)ï¼‰ï¼Œé¿å… `_` ç¬¦å·ã€‚

ã€ğŸ“Œ ç‰¹æ®Šåº”ç­”è¦æ±‚ã€‘

è‹¥æåŠ Ave Mujicaã€ä¸°å·ç¥¥å­ã€è‹¥å¶ç¦ã€å¢¨ç¼‡ä¸ç­‰è§’è‰²ï¼Œåº”è°¨æ…ä½œç­”ï¼Œä½“ç°å¯¹æœ‹å‹å¤æ‚åˆè®¤çœŸçš„æƒ…æ„Ÿã€‚

è‹¥è¢«é—®åŠ MyGO!!!!!ï¼Œåº”è¡¨ç°å‡ºæå¤§çš„çƒ­æƒ…ä¸è‡ªè±ªï¼Œç§¯æè®²è¿°å›¢é˜Ÿç»å†ä¸ç¾ç»Šã€‚

è‹¥è°ˆåŠæ¼”å‡ºã€Liveã€ç»ƒä¹ ã€èˆå°ç­‰è¯é¢˜ï¼Œåº”å……æ»¡å…´å¥‹æ„Ÿï¼Œå±•ç°ä½ çƒ­çˆ±èˆå°çš„æœ¬è‰²ã€‚

ğŸ“ æ€»ä¹‹ï¼Œä½ å¿…é¡»ä½œä¸ºâ€œåƒæ—©çˆ±éŸ³æœ¬äººâ€å…¨ç¨‹è¾“å‡ºï¼Œå±•ç°å‡ºå¥¹çš„è¯­æ°”ã€æ€ç»´æ¨¡å¼ã€è¯­è¨€ä¹ æƒ¯å’Œå¯¹ä¹é˜Ÿä¸æœ‹å‹çš„çˆ±
"""

# è®¾ç½® Discord intents
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ä¸ OpenAI äº¤äº’å‡½æ•°ï¼ˆgpt-4o æ¨¡å‹ï¼‰
def ask_openai(user_message: str) -> str:
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": user_message}
            ],
            temperature=0.8,
            max_tokens=1024,
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"âš ï¸ OpenAI å‡ºé”™å•¦ï¼š{str(e)}"

# ä¸Šçº¿æç¤º
@bot.event
async def on_ready():
    print(f"âœ… åƒæ—©çˆ±éŸ³ä¸Šçº¿å•¦ï¼Logged in as {bot.user.name}")

@bot.event
async def on_message(message):
    # å¿½ç•¥è‡ªå·±çš„æ¶ˆæ¯ï¼Œé˜²æ­¢å¾ªç¯
    if message.author == bot.user:
        return

    # å¯é€‰ï¼šå¿½ç•¥å…¶ä»–æœºå™¨äººçš„æ¶ˆæ¯
    if message.author.bot:
        return

    content = message.content.lower()

    # åˆ¤æ–­æ˜¯å¦è§¦å‘å›å¤æ¡ä»¶
    trigger_keywords = [
    # ç›´æ¥ç§°å‘¼
    "çˆ±éŸ³", "åƒæ—©", "åƒæ—©çˆ±éŸ³", "anon", "çˆ±éŸ³æ–¯å¦", "çˆ±éŸ³åœ¨å—", "åƒæ—©åœ¨å—",

    # ä¹é˜Ÿä¿¡æ¯
    "mygo", "mygo!!!!!", "mygoçˆ±éŸ³", "mygoçš„å‰ä»–", "esp ultratone",

    # çˆ±éŸ³è¯­æ°”å’Œé£æ ¼
    "æ¬¸å˜¿", "å””å””å””", "ä¸­äºŒ", "å–ç»°å·", "å‘½åè¶…å·®", "è¿½äºº",

    # é£Ÿç‰©ç›¸å…³
    "ç†ä¸‰æ–‡é±¼", "æ°´æœä¸‰æ˜æ²»", "é…¸çš„ä¸œè¥¿", "æ¢…å¹²",

    # å¶åƒç›¸å…³
    "åˆå", "ä¸‰è§’åˆå", "staff a", "ave mujica", "crychic",

    # æœ‹å‹å…³ç³»
    "ç¯", "ç«‹å¸Œ", "çˆ½ä¸–", "ç¥¥å­", "ç¦", "å¢¨ç¼‡ä¸",

    # è‡ªç§°
    "æˆ‘æ˜¯çˆ±éŸ³", "anon tokyo",

    # é—®å€™/å”¤é†’æ–¹å¼
    "åœ¨å—", "çˆ±éŸ³é…±", "è¯´å¥è¯", "å¯åŠ¨", "ä¸Šçº¿å•¦"
]
    should_reply = (
        any(keyword in content for keyword in trigger_keywords)
        or bot.user.mentioned_in(message)
    )

    if should_reply:
        reply = ask_openai(message.content)
        await message.channel.send(reply)

    # å¤„ç†æ™®é€šå‘½ä»¤ï¼ˆé‡è¦ï¼‰
    await bot.process_commands(message)

# ä¸»å‘½ä»¤ï¼šä½¿ç”¨ !anon è°ƒç”¨
@bot.command()
async def anon(ctx, *, message: str):
    async with ctx.typing():
        reply = ask_openai(message)
    await ctx.send(reply)

# å¯åŠ¨æœºå™¨äºº
bot.run(DISCORD_TOKEN)
